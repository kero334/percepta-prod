<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Percepta AI - Enterprise Safety Monitoring</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --bg-dark: #0a0e17;
            --bg-card: #0f1419;
            --bg-elevated: #1a1f2e;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border-color: rgba(148, 163, 184, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(239, 68, 68, 0.1) 0%, transparent 40%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        /* Glass Morphism */
        .glass {
            background: rgba(15, 20, 25, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-strong {
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-card);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* Loading Animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Pulse Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        /* Scan Line */
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { top: 100%; opacity: 0; }
        }

        .scan-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--danger), transparent);
            box-shadow: 0 0 20px var(--danger);
            animation: scan 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 100;
        }

        /* Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: relative;
        }

        .status-dot::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            border: 2px solid currentColor;
            opacity: 0;
            animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* Risk Level Badges */
        .risk-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-low {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .risk-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .risk-high {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .risk-critical {
            background: rgba(239, 68, 68, 0.3);
            color: #ff0000;
            border: 1px solid rgba(255, 0, 0, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        /* Card Hover Effect */
        .hover-card {
            transition: all 0.3s ease;
        }

        .hover-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.2);
            border-color: var(--primary);
        }

        /* Canvas Container */
        .canvas-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        /* Empty State */
        .empty-state {
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            color: var(--text-secondary);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 32px;
            border-radius: 16px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 2000;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .toast-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .toast-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        /* Analysis Mode Selector */
        .mode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .mode-card {
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .mode-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .mode-card.active {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .stat-card {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        /* Detection Legend */
        .detection-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            font-size: 12px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .mode-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="animated-bg"></div>

    <!-- Main Container -->
    <div class="relative z-10 h-screen flex flex-col">
        <!-- Header -->
        <header class="glass border-b border-white/10">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg">
                        <i class="fas fa-eye text-2xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Percepta AI</h1>
                        <p class="text-xs text-gray-400 font-mono">Enterprise Safety Monitor v2.0</p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Status Indicators -->
                    <div class="hidden md:flex items-center gap-3">
                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg glass">
                            <div id="status-vision" class="status-dot bg-red-500"></div>
                            <span class="text-xs font-mono">Vision</span>
                        </div>
                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg glass">
                            <div id="status-reasoning" class="status-dot bg-red-500"></div>
                            <span class="text-xs font-mono">AI Brain</span>
                        </div>
                    </div>

                    <!-- Settings Button -->
                    <button onclick="openSettings()" class="btn btn-primary">
                        <i class="fas fa-cog mr-2"></i> Settings
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 overflow-hidden flex">
            <!-- Left Panel - Analysis View -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="p-6 space-y-6 overflow-y-auto">
                    <!-- Analysis Mode Selector -->
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-sm font-bold uppercase tracking-wider text-gray-400 mb-4">Analysis Mode</h3>
                        <div class="mode-selector">
                            <div class="mode-card glass active" onclick="setAnalysisMode('comprehensive')" data-mode="comprehensive">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-shield-alt text-blue-500 text-xl"></i>
                                    <h4 class="font-bold">Comprehensive</h4>
                                </div>
                                <p class="text-xs text-gray-400">Full safety analysis with PPE, proximity, and risk assessment</p>
                            </div>
                            <div class="mode-card glass" onclick="setAnalysisMode('ppe')" data-mode="ppe">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-hard-hat text-yellow-500 text-xl"></i>
                                    <h4 class="font-bold">PPE Focus</h4>
                                </div>
                                <p class="text-xs text-gray-400">Specialized PPE compliance checking</p>
                            </div>
                            <div class="mode-card glass" onclick="setAnalysisMode('proximity')" data-mode="proximity">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                                    <h4 class="font-bold">Proximity Alert</h4>
                                </div>
                                <p class="text-xs text-gray-400">Focus on human-machinery distance hazards</p>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Area -->
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-sm font-bold uppercase tracking-wider text-gray-400 mb-4">Image Input</h3>
                        <div class="space-y-4">
                            <!-- Upload Button -->
                            <label class="block cursor-pointer group">
                                <div class="glass-strong rounded-xl p-8 border-2 border-dashed border-gray-700 hover:border-blue-500 transition-all text-center group-hover:bg-blue-500/5">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-blue-500 mb-4"></i>
                                    <p class="font-semibold text-lg mb-2">Upload Image</p>
                                    <p class="text-sm text-gray-400">Click to select or drag & drop</p>
                                    <p class="text-xs text-gray-500 mt-2">Supports JPG, PNG, WebP (Max 10MB)</p>
                                </div>
                                <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                            </label>

                            <!-- Quick Test -->
                            <button onclick="loadDemoImage()" class="w-full glass rounded-xl p-4 hover:bg-blue-500/10 transition-all border border-transparent hover:border-blue-500 flex items-center justify-center gap-3">
                                <i class="fas fa-bolt text-yellow-500"></i>
                                <span class="font-semibold">Quick Test with Demo Image</span>
                            </button>
                        </div>
                    </div>

                    <!-- Analysis Canvas -->
                    <div id="canvas-section" class="glass rounded-xl p-6 hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-bold uppercase tracking-wider text-gray-400">Visual Analysis</h3>
                            <div class="flex gap-2">
                                <button onclick="retakePhoto()" class="px-4 py-2 glass rounded-lg hover:bg-white/5 transition-all text-sm">
                                    <i class="fas fa-redo mr-2"></i>New Image
                                </button>
                                <button onclick="downloadImage()" class="px-4 py-2 glass rounded-lg hover:bg-white/5 transition-all text-sm">
                                    <i class="fas fa-download mr-2"></i>Download
                                </button>
                            </div>
                        </div>

                        <!-- Detection Legend -->
                        <div class="detection-legend mb-4">
                            <div class="legend-item">
                                <div class="legend-color bg-red-500"></div>
                                <span>Humans</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color bg-yellow-500"></div>
                                <span>Machinery</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color bg-blue-500"></div>
                                <span>Objects</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color bg-green-500"></div>
                                <span>PPE Detected</span>
                            </div>
                        </div>

                        <div class="canvas-container">
                            <div id="scan-line" class="scan-line" style="display: none;"></div>
                            <canvas id="analysis-canvas"></canvas>
                            <img id="analysis-image" style="display: none;">
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="empty-state" class="glass rounded-xl">
                        <div class="empty-state">
                            <i class="fas fa-image text-6xl text-gray-700"></i>
                            <p class="text-xl font-semibold">No Image Loaded</p>
                            <p class="text-sm text-gray-400">Upload an image or use demo to start analysis</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Results -->
            <div class="w-96 border-l border-white/10 glass flex flex-col overflow-hidden">
                <div class="p-6 border-b border-white/10">
                    <h3 class="text-sm font-bold uppercase tracking-wider text-gray-400">Analysis Results</h3>
                </div>

                <div id="results-panel" class="flex-1 overflow-y-auto p-6 space-y-6">
                    <!-- Loading State -->
                    <div id="loading-state" class="hidden">
                        <div class="text-center py-12">
                            <i class="fas fa-circle-notch text-4xl text-blue-500 spinner mb-4"></i>
                            <p class="font-semibold mb-2">Analyzing Image...</p>
                            <p class="text-sm text-gray-400" id="loading-status">Initializing AI models...</p>
                            <div class="mt-4 w-full bg-gray-800 rounded-full h-2 overflow-hidden">
                                <div id="loading-progress" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Results State -->
                    <div id="results-content" class="space-y-6 hidden">
                        <!-- Risk Score -->
                        <div class="glass-strong rounded-xl p-6">
                            <h4 class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-4">Risk Assessment</h4>
                            <div class="text-center mb-4">
                                <div id="risk-score" class="text-5xl font-black mb-2">--</div>
                                <div id="risk-level" class="risk-badge risk-medium inline-block">Analyzing</div>
                            </div>
                            <div class="w-full bg-gray-800 rounded-full h-3 overflow-hidden">
                                <div id="risk-bar" class="h-full transition-all duration-1000 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Detection Stats -->
                        <div class="glass-strong rounded-xl p-6">
                            <h4 class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-4">Detections</h4>
                            <div class="stats-grid">
                                <div class="stat-card glass">
                                    <div id="stat-humans" class="stat-value text-red-500">0</div>
                                    <div class="stat-label">Workers</div>
                                </div>
                                <div class="stat-card glass">
                                    <div id="stat-machines" class="stat-value text-yellow-500">0</div>
                                    <div class="stat-label">Machinery</div>
                                </div>
                                <div class="stat-card glass">
                                    <div id="stat-hazards" class="stat-value text-red-500">0</div>
                                    <div class="stat-label">Hazards</div>
                                </div>
                                <div class="stat-card glass">
                                    <div id="stat-ppe" class="stat-value text-green-500">0%</div>
                                    <div class="stat-label">PPE Rate</div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Report -->
                        <div class="glass-strong rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-xs font-bold uppercase tracking-wider text-gray-400">AI Safety Report</h4>
                                <button onclick="exportReport()" class="px-3 py-1.5 glass rounded-lg hover:bg-white/5 transition-all text-xs">
                                    <i class="fas fa-file-pdf mr-1"></i>Export PDF
                                </button>
                            </div>
                            <div id="ai-report" class="prose prose-invert prose-sm max-w-none">
                                <p class="text-gray-400 text-sm">Analysis results will appear here...</p>
                            </div>
                        </div>

                        <!-- Incident Log -->
                        <div class="glass-strong rounded-xl p-6">
                            <h4 class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-4">Detected Issues</h4>
                            <div id="incident-list" class="space-y-2">
                                <p class="text-gray-400 text-sm">No incidents detected</p>
                            </div>
                        </div>
                    </div>

                    <!-- Idle State -->
                    <div id="idle-state" class="text-center py-12">
                        <i class="fas fa-clipboard-check text-4xl text-gray-700 mb-4"></i>
                        <p class="text-gray-400">Upload an image to see analysis results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content glass-strong rounded-xl">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Settings</h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- API Keys -->
                <div>
                    <h3 class="text-sm font-bold uppercase tracking-wider text-gray-400 mb-4">Google Gemini API Key</h3>
                    <input type="password" id="api-key-input" placeholder="Enter your Gemini API key" 
                           class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg focus:border-blue-500 focus:outline-none transition-colors">
                    <p class="text-xs text-gray-500 mt-2">Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-500 hover:underline">Google AI Studio</a></p>
                </div>

                <!-- Sensitivity Settings -->
                <div>
                    <h3 class="text-sm font-bold uppercase tracking-wider text-gray-400 mb-4">Detection Sensitivity</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-300 mb-2 block">Proximity Threshold (meters)</label>
                            <input type="range" id="proximity-threshold" min="1" max="10" value="3" step="0.5" 
                                   class="w-full" oninput="updateThresholdDisplay(this, 'proximity-value')">
                            <div class="text-right text-xs text-gray-400 mt-1">
                                <span id="proximity-value">3.0</span> meters
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-300 mb-2 block">Detection Confidence</label>
                            <input type="range" id="confidence-threshold" min="0.3" max="0.9" value="0.6" step="0.05" 
                                   class="w-full" oninput="updateThresholdDisplay(this, 'confidence-value')">
                            <div class="text-right text-xs text-gray-400 mt-1">
                                <span id="confidence-value">60</span>%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <button onclick="saveSettings()" class="w-full btn btn-primary">
                    <i class="fas fa-save mr-2"></i>Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Global State
        const STATE = {
            apiKey: localStorage.getItem('gemini_api_key') || '',
            analysisMode: 'comprehensive',
            currentImage: null,
            detections: [],
            aiReport: null,
            settings: {
                proximityThreshold: 3.0,
                confidenceThreshold: 0.6
            },
            cocoModel: null,
            modelsLoaded: false
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            loadSettings();
            await initializeModels();
            updateStatusIndicators();
            setupDragAndDrop();
        });

        // Load settings from localStorage
        function loadSettings() {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                STATE.apiKey = savedKey;
                document.getElementById('api-key-input').value = savedKey;
            }

            const savedProximity = localStorage.getItem('proximity_threshold');
            if (savedProximity) {
                STATE.settings.proximityThreshold = parseFloat(savedProximity);
                document.getElementById('proximity-threshold').value = savedProximity;
                document.getElementById('proximity-value').textContent = savedProximity;
            }

            const savedConfidence = localStorage.getItem('confidence_threshold');
            if (savedConfidence) {
                STATE.settings.confidenceThreshold = parseFloat(savedConfidence);
                document.getElementById('confidence-threshold').value = savedConfidence;
                document.getElementById('confidence-value').textContent = (parseFloat(savedConfidence) * 100).toFixed(0);
            }
        }

        // Save settings
        function saveSettings() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            const proximityThreshold = document.getElementById('proximity-threshold').value;
            const confidenceThreshold = document.getElementById('confidence-threshold').value;

            if (apiKey) {
                STATE.apiKey = apiKey;
                localStorage.setItem('gemini_api_key', apiKey);
            }

            STATE.settings.proximityThreshold = parseFloat(proximityThreshold);
            STATE.settings.confidenceThreshold = parseFloat(confidenceThreshold);
            
            localStorage.setItem('proximity_threshold', proximityThreshold);
            localStorage.setItem('confidence_threshold', confidenceThreshold);

            updateStatusIndicators();
            closeSettings();
            showToast('Settings saved successfully', 'success');
        }

        // Initialize AI Models
        async function initializeModels() {
            try {
                showToast('Loading AI models...', 'warning');
                STATE.cocoModel = await cocoSsd.load();
                STATE.modelsLoaded = true;
                updateStatusIndicators();
                showToast('AI models loaded successfully', 'success');
            } catch (error) {
                console.error('Model loading failed:', error);
                showToast('Failed to load AI models', 'error');
            }
        }

        // Update status indicators
        function updateStatusIndicators() {
            const visionStatus = document.getElementById('status-vision');
            const reasoningStatus = document.getElementById('status-reasoning');

            if (STATE.modelsLoaded) {
                visionStatus.className = 'status-dot bg-green-500';
            } else {
                visionStatus.className = 'status-dot bg-red-500';
            }

            if (STATE.apiKey) {
                reasoningStatus.className = 'status-dot bg-green-500';
            } else {
                reasoningStatus.className = 'status-dot bg-red-500';
            }
        }

        // Set analysis mode
        function setAnalysisMode(mode) {
            STATE.analysisMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-card').forEach(card => {
                if (card.dataset.mode === mode) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });

            showToast(`Analysis mode: ${mode}`, 'success');
        }

        // Handle file upload
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file
            if (!file.type.startsWith('image/')) {
                showToast('Please upload a valid image file', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showToast('File size must be less than 10MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const img = document.getElementById('analysis-image');
                img.src = e.target.result;
                img.onload = () => {
                    STATE.currentImage = img;
                    runAnalysis();
                };
            };
            reader.readAsDataURL(file);
        }

        // Load demo image
        function loadDemoImage() {
            const img = document.getElementById('analysis-image');
            img.src = 'https://images.unsplash.com/photo-1504307651254-35680f356dfd?q=80&w=1200&auto=format&fit=crop';
            img.onload = () => {
                STATE.currentImage = img;
                runAnalysis();
            };
        }

        // Run complete analysis
        async function runAnalysis() {
            if (!STATE.modelsLoaded) {
                showToast('AI models not loaded yet. Please wait...', 'warning');
                return;
            }

            if (!STATE.apiKey) {
                showToast('Please configure your Gemini API key in settings', 'warning');
                openSettings();
                return;
            }

            try {
                // Show loading state
                showLoading();

                // Step 1: Object Detection (30%)
                updateLoadingStatus('Detecting objects...', 30);
                await new Promise(resolve => setTimeout(resolve, 500));
                const detections = await STATE.cocoModel.detect(STATE.currentImage);
                STATE.detections = processDetections(detections);

                // Step 2: Visual Rendering (60%)
                updateLoadingStatus('Rendering visual analysis...', 60);
                await new Promise(resolve => setTimeout(resolve, 500));
                renderVisualAnalysis();

                // Step 3: AI Analysis (90%)
                updateLoadingStatus('Analyzing safety conditions...', 90);
                await new Promise(resolve => setTimeout(resolve, 500));
                const aiAnalysis = await runGeminiAnalysis();

                // Step 4: Display Results (100%)
                updateLoadingStatus('Finalizing report...', 100);
                await new Promise(resolve => setTimeout(resolve, 500));
                displayResults(aiAnalysis);

                hideLoading();
                showToast('Analysis complete!', 'success');

            } catch (error) {
                console.error('Analysis failed:', error);
                hideLoading();
                showToast('Analysis failed: ' + error.message, 'error');
            }
        }

        // Process detections
        function processDetections(detections) {
            return detections.map(det => {
                const [x, y, width, height] = det.bbox;
                const centerX = x + width / 2;
                const centerY = y + height / 2;

                let category = 'object';
                let color = '#3b82f6';

                if (det.class.includes('person')) {
                    category = 'human';
                    color = '#ef4444';
                } else if (['car', 'truck', 'bus', 'motorcycle', 'bicycle'].includes(det.class)) {
                    category = 'machinery';
                    color = '#f59e0b';
                }

                return {
                    ...det,
                    category,
                    color,
                    centerX,
                    centerY,
                    bbox: [x, y, width, height]
                };
            }).filter(det => det.score >= STATE.settings.confidenceThreshold);
        }

        // Render visual analysis on canvas
        function renderVisualAnalysis() {
            const canvas = document.getElementById('analysis-canvas');
            const ctx = canvas.getContext('2d');
            const img = STATE.currentImage;

            // Set canvas size
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw image
            ctx.drawImage(img, 0, 0);

            // Separate detections by category
            const humans = STATE.detections.filter(d => d.category === 'human');
            const machines = STATE.detections.filter(d => d.category === 'machinery');
            const objects = STATE.detections.filter(d => d.category === 'object');

            // Draw proximity hazard lines first (behind boxes)
            ctx.setLineDash([10, 10]);
            ctx.lineWidth = 3;
            
            humans.forEach(human => {
                machines.forEach(machine => {
                    const distance = Math.hypot(human.centerX - machine.centerX, human.centerY - machine.centerY);
                    const pixelThreshold = (STATE.settings.proximityThreshold / 5) * canvas.width * 0.2;

                    if (distance < pixelThreshold) {
                        // Draw danger line
                        ctx.strokeStyle = '#ef4444';
                        ctx.beginPath();
                        ctx.moveTo(human.centerX, human.centerY);
                        ctx.lineTo(machine.centerX, machine.centerY);
                        ctx.stroke();

                        // Draw danger label
                        const midX = (human.centerX + machine.centerX) / 2;
                        const midY = (human.centerY + machine.centerY) / 2;
                        
                        ctx.fillStyle = '#ef4444';
                        ctx.fillRect(midX - 40, midY - 12, 80, 24);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 14px Inter';
                        ctx.textAlign = 'center';
                        ctx.fillText('DANGER', midX, midY + 5);
                    }
                });
            });

            ctx.setLineDash([]);

            // Draw all detections
            STATE.detections.forEach(det => {
                const [x, y, width, height] = det.bbox;

                // Draw bounding box
                ctx.strokeStyle = det.color;
                ctx.lineWidth = 4;
                ctx.strokeRect(x, y, width, height);

                // Draw label background
                const label = `${det.class.toUpperCase()} ${Math.round(det.score * 100)}%`;
                ctx.font = 'bold 16px Inter';
                const textWidth = ctx.measureText(label).width + 16;
                const labelY = y > 30 ? y - 30 : y + height + 5;

                ctx.fillStyle = det.color;
                ctx.fillRect(x, labelY, textWidth, 28);

                // Draw label text
                ctx.fillStyle = '#ffffff';
                ctx.fillText(label, x + 8, labelY + 19);

                // Draw corner brackets
                const cornerSize = 15;
                ctx.strokeStyle = det.color;
                ctx.lineWidth = 2;

                // Top-left
                ctx.beginPath();
                ctx.moveTo(x, y + cornerSize);
                ctx.lineTo(x, y);
                ctx.lineTo(x + cornerSize, y);
                ctx.stroke();

                // Top-right
                ctx.beginPath();
                ctx.moveTo(x + width - cornerSize, y);
                ctx.lineTo(x + width, y);
                ctx.lineTo(x + width, y + cornerSize);
                ctx.stroke();

                // Bottom-left
                ctx.beginPath();
                ctx.moveTo(x, y + height - cornerSize);
                ctx.lineTo(x, y + height);
                ctx.lineTo(x + cornerSize, y + height);
                ctx.stroke();

                // Bottom-right
                ctx.beginPath();
                ctx.moveTo(x + width - cornerSize, y + height);
                ctx.lineTo(x + width, y + height);
                ctx.lineTo(x + width, y + height - cornerSize);
                ctx.stroke();
            });

            // Show canvas section
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('canvas-section').classList.remove('hidden');

            // Trigger scan animation
            const scanLine = document.getElementById('scan-line');
            scanLine.style.display = 'block';
            setTimeout(() => {
                scanLine.style.display = 'none';
            }, 3000);
        }

        // Run Gemini AI analysis
        async function runGeminiAnalysis() {
            const canvas = document.getElementById('analysis-canvas');
            const base64Image = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

            // Build analysis prompt based on mode
            let prompt = buildAnalysisPrompt();

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${STATE.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inline_data: { mime_type: 'image/jpeg', data: base64Image } }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.4,
                            topK: 32,
                            topP: 1,
                            maxOutputTokens: 2048,
                        },
                        safetySettings: [
                            { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                // Parse JSON response
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                } else {
                    throw new Error('Invalid AI response format');
                }

            } catch (error) {
                console.error('Gemini API error:', error);
                throw new Error('AI analysis failed: ' + error.message);
            }
        }

        // Build analysis prompt based on mode
        function buildAnalysisPrompt() {
            const humans = STATE.detections.filter(d => d.category === 'human').length;
            const machines = STATE.detections.filter(d => d.category === 'machinery').length;

            const baseContext = `
You are an expert workplace safety AI analyzing a construction/industrial site image.

DETECTED OBJECTS:
- ${humans} worker(s) detected
- ${machines} machinery/vehicle(s) detected
- Total objects: ${STATE.detections.length}

ANALYSIS MODE: ${STATE.analysisMode.toUpperCase()}
`;

            let specificInstructions = '';

            if (STATE.analysisMode === 'comprehensive') {
                specificInstructions = `
Perform a complete safety analysis including:
1. PPE Compliance (hard hats, safety vests, goggles, gloves, boots)
2. Proximity hazards between workers and machinery
3. Unsafe working conditions or practices
4. Environmental hazards
5. Overall workplace organization and safety culture indicators
`;
            } else if (STATE.analysisMode === 'ppe') {
                specificInstructions = `
Focus specifically on PPE (Personal Protective Equipment) compliance:
1. Identify each worker and their visible PPE
2. Check for: hard hats, high-visibility vests, safety goggles, gloves, steel-toe boots
3. Note any missing or improperly worn equipment
4. Calculate compliance percentage
5. Provide specific recommendations for each violation
`;
            } else if (STATE.analysisMode === 'proximity') {
                specificInstructions = `
Focus on proximity and distance hazards:
1. Identify dangerous proximities between workers and machinery
2. Assess movement paths and potential collision zones
3. Check for adequate safety barriers and warning systems
4. Evaluate spatial organization and traffic flow
5. Flag any worker in immediate danger zones
`;
            }

            return `${baseContext}

${specificInstructions}

Respond with a JSON object in this EXACT format:
{
  "risk_score": <number 0-100>,
  "risk_level": "<LOW|MEDIUM|HIGH|CRITICAL>",
  "executive_summary": "<2-3 sentences overview>",
  "ppe_compliance_rate": <number 0-100>,
  "violations": [
    {
      "type": "<violation type>",
      "severity": "<LOW|MEDIUM|HIGH|CRITICAL>",
      "description": "<specific description>",
      "recommendation": "<specific action to take>"
    }
  ],
  "positive_observations": ["<observation 1>", "<observation 2>"],
  "detailed_report": "<markdown formatted detailed analysis>",
  "immediate_actions": ["<action 1>", "<action 2>"]
}

Be specific, actionable, and professional. Consider cultural context and realistic workplace scenarios.`;
        }

        // Display analysis results
        function displayResults(analysis) {
            STATE.aiReport = analysis;

            // Show results panel
            document.getElementById('idle-state').classList.add('hidden');
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('results-content').classList.remove('hidden');

            // Update risk score
            document.getElementById('risk-score').textContent = analysis.risk_score;
            const riskLevel = document.getElementById('risk-level');
            riskLevel.textContent = analysis.risk_level;
            riskLevel.className = `risk-badge risk-${analysis.risk_level.toLowerCase()}`;

            // Update risk bar
            const riskBar = document.getElementById('risk-bar');
            riskBar.style.width = analysis.risk_score + '%';
            
            if (analysis.risk_score < 30) {
                riskBar.style.background = 'linear-gradient(90deg, #10b981, #059669)';
            } else if (analysis.risk_score < 70) {
                riskBar.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
            } else {
                riskBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
            }

            // Update stats
            const humans = STATE.detections.filter(d => d.category === 'human').length;
            const machines = STATE.detections.filter(d => d.category === 'machinery').length;
            const hazards = analysis.violations.filter(v => v.severity === 'HIGH' || v.severity === 'CRITICAL').length;

            document.getElementById('stat-humans').textContent = humans;
            document.getElementById('stat-machines').textContent = machines;
            document.getElementById('stat-hazards').textContent = hazards;
            document.getElementById('stat-ppe').textContent = Math.round(analysis.ppe_compliance_rate) + '%';

            // Update AI report
            document.getElementById('ai-report').innerHTML = marked.parse(analysis.detailed_report);

            // Update incident list
            const incidentList = document.getElementById('incident-list');
            if (analysis.violations.length > 0) {
                incidentList.innerHTML = analysis.violations.map(v => `
                    <div class="glass p-3 rounded-lg border-l-4 ${getSeverityBorderColor(v.severity)}">
                        <div class="flex items-start justify-between mb-1">
                            <span class="font-semibold text-sm">${v.type}</span>
                            <span class="risk-badge risk-${v.severity.toLowerCase()} text-xs">${v.severity}</span>
                        </div>
                        <p class="text-xs text-gray-400 mb-2">${v.description}</p>
                        <p class="text-xs text-blue-400">
                            <i class="fas fa-lightbulb mr-1"></i>${v.recommendation}
                        </p>
                    </div>
                `).join('');
            } else {
                incidentList.innerHTML = '<p class="text-gray-400 text-sm">No critical incidents detected</p>';
            }
        }

        // Get severity border color
        function getSeverityBorderColor(severity) {
            switch (severity) {
                case 'LOW': return 'border-green-500';
                case 'MEDIUM': return 'border-yellow-500';
                case 'HIGH': return 'border-orange-500';
                case 'CRITICAL': return 'border-red-500';
                default: return 'border-gray-500';
            }
        }

        // Loading state management
        function showLoading() {
            document.getElementById('idle-state').classList.add('hidden');
            document.getElementById('results-content').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-state').classList.add('hidden');
        }

        function updateLoadingStatus(status, progress) {
            document.getElementById('loading-status').textContent = status;
            document.getElementById('loading-progress').style.width = progress + '%';
        }

        // Utility functions
        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function updateThresholdDisplay(input, displayId) {
            const value = parseFloat(input.value);
            const display = document.getElementById(displayId);
            
            if (displayId === 'proximity-value') {
                display.textContent = value.toFixed(1);
            } else {
                display.textContent = Math.round(value * 100);
            }
        }

        function retakePhoto() {
            STATE.currentImage = null;
            STATE.detections = [];
            STATE.aiReport = null;
            
            document.getElementById('canvas-section').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('results-content').classList.add('hidden');
            document.getElementById('idle-state').classList.remove('hidden');
            
            document.getElementById('file-upload').value = '';
        }

        function downloadImage() {
            const canvas = document.getElementById('analysis-canvas');
            const link = document.createElement('a');
            link.download = `percepta-analysis-${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();
        }

        function exportReport() {
            if (!STATE.aiReport) return;

            const element = document.createElement('div');
            element.style.padding = '40px';
            element.style.fontFamily = 'Inter, sans-serif';
            element.style.color = '#000';
            
            element.innerHTML = `
                <h1 style="color: #3b82f6; margin-bottom: 20px;">Percepta AI Safety Report</h1>
                <p style="color: #666; margin-bottom: 30px;">${new Date().toLocaleString()}</p>
                
                <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                    <h2 style="color: #1f2937; margin-bottom: 10px;">Risk Assessment</h2>
                    <p style="font-size: 24px; font-weight: bold; color: ${STATE.aiReport.risk_score > 70 ? '#ef4444' : STATE.aiReport.risk_score > 30 ? '#f59e0b' : '#10b981'}">
                        ${STATE.aiReport.risk_score}/100 - ${STATE.aiReport.risk_level}
                    </p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h2 style="color: #1f2937; margin-bottom: 10px;">Executive Summary</h2>
                    <p style="color: #4b5563;">${STATE.aiReport.executive_summary}</p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h2 style="color: #1f2937; margin-bottom: 10px;">Detailed Analysis</h2>
                    <div style="color: #4b5563;">${marked.parse(STATE.aiReport.detailed_report)}</div>
                </div>
                
                <div>
                    <h2 style="color: #1f2937; margin-bottom: 10px;">Violations Detected</h2>
                    ${STATE.aiReport.violations.map(v => `
                        <div style="border-left: 4px solid ${v.severity === 'CRITICAL' ? '#ef4444' : v.severity === 'HIGH' ? '#f59e0b' : '#10b981'}; padding-left: 15px; margin-bottom: 15px;">
                            <h3 style="color: #1f2937; font-size: 16px; margin-bottom: 5px;">${v.type}</h3>
                            <p style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">${v.description}</p>
                            <p style="color: #3b82f6; font-size: 13px;"><strong>Action:</strong> ${v.recommendation}</p>
                        </div>
                    `).join('')}
                </div>
            `;

            html2pdf()
                .from(element)
                .set({
                    margin: 1,
                    filename: `percepta-report-${Date.now()}.pdf`,
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                })
                .save();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Setup drag and drop
        function setupDragAndDrop() {
            const uploadArea = document.querySelector('label[for="file-upload"]');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('bg-blue-500/10');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('bg-blue-500/10');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('bg-blue-500/10');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    const input = document.getElementById('file-upload');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    input.files = dataTransfer.files;
                    handleFileUpload({ target: input });
                }
            });
        }

        // Close modal when clicking outside
        document.getElementById('settings-modal').addEventListener('click', (e) => {
            if (e.target.id === 'settings-modal') {
                closeSettings();
            }
        });
    </script>
</body>
</html>